version: '3.2'
#SHIELD_YML_VERSION:8.0.0.107a 

services:
    collector:
      image: securebrowsing/shield-collector:latest
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - /proc:/hostfs/proc:ro
        - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
        - /:/hostfs:ro
      environment:
        - "SYSTEM_PERIOD=5m"
        - "DOCKER_PERIOD=5m"
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 2GB
            cpus: "1"

    elk:
      image: securebrowsing/shield-elk:latest
      ports:
          - 5601:5601
          - 5044:5044
          - 9200:9200
      healthcheck:
        test: ["CMD-SHELL", "curl -s -XGET 'http://localhost:9200/_cluster/health' | grep -q yellow"]
        interval: 20s
        timeout: 10s
        retries: 5
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 2GB
            cpus: "1"

    consul:
      image: securebrowsing/shield-configuration:latest
      ports:
        - "8500:8500"
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        mode: global
        resources:
          limits:
            memory: 1GB
            cpus: "1"
      environment:
        - "CONSUL_BIND_INTERFACE=eth2"
        - "NUMBER_OF_EXPECTED=1"

###################################################################### Shield services part ##################################################################
    shield-admin:
      image: securebrowsing/shield-admin:latest
      ports:
        - 8181:8181
      environment:
        - SHIELD_VER=8.0.0.latest
      volumes:
        - admin:/data/consul
      networks:
        - shield
      deploy:
        resources:
          limits:
            memory: 1GB
            cpus: "1"

    icap-server:
      image: securebrowsing/icap-server:latest
      hostname: icap-server
      environment:
        - NODE_ENV=production
        - SHIELD_VER=8.0.0.latest
        - MAX_ELASTIC_CHECK_ATTEMPTS=40
        - NO_FOLLOW_REDIRECT=true
        - "SHIELD_IP=IP_ADDRESS"
#         - SHIELD_WATERMARK=TRUE
      ulimits:
        nofile:
          soft: 65535
          hard: 65535
      ports:
        - 1344:1344          
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 1GB
            cpus: "1"
        replicas: 1
        placement:
          constraints:
            - node.role==manager
      networks:
        - shield

    broker-server:
      image: securebrowsing/broker-server:latest
      hostname: broker-server
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
      environment:
        - NODE_ENV=production
      secrets:
        - shield-system-id
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 1GB
            cpus: "1"

    shield-browser:
      image: securebrowsing/shield-cef:latest
      labels:
        - com.ericom.browser
      environment:
        - FPS=25
        - DISPOSE_BROWSER=true
        #- DEBUG_REMOTE_SITE=true
        - PERF_STATS=true
        #- RUN_WITH_DEBUGGER=false
        #- EXTProxyAddress=
        #- DEBUG_SEND_LOG_TO_AN=true
      # ports:
      #    - "3656:3656"
      #  volumes:
      #    - /home/lev/projects/SB/Containers/Docker/shield-cef/src:/app/src
      deploy:
        update_config:
          parallelism: 0
      #  Starting with one Browser, Broker will scale according to Pool Settings
        replicas: 1
        restart_policy:
          condition: none
        resources:
          limits:
            memory: 1GB
            cpus: "1"
          reservations:
            memory: 250MB
  
      networks:
        - shield
      volumes:
        - type: tmpfs
          target: /dev/shm
        - type: bind
          target: /dev/shm/xorg
          source: /tmp/containershm

    proxy-server:
      image: securebrowsing/proxy-server:latest
      ports:
        - "3128:3128"
      ulimits:
        nofile:
          soft: 65535
          hard: 65535
      environment:
        - SSLEXCLUSION=true
      deploy:
        restart_policy:
          condition: on-failure
        placement:
          constraints:
            - node.role==manager
        resources:
          limits:
            memory: 1GB
            cpus: "2"
      networks:
        - shield

    ext-proxy:
      image: securebrowsing/extproxy:170605-11.44
      ports:
        - "3138:3138"
      ulimits:
        nofile:
          soft: 65535
          hard: 65535
      deploy:
        replicas: 0
        placement:
          constraints:
            - node.role==manager
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 1GB
            cpus: "1"

    ############################### Docker managment part ##############################################################
    portainer:
      image: securebrowsing/shield-portainer:latest
      hostname: portainer
      ports:
        - "9000:9000"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - portainer:/data
      networks:
        - shield
      deploy:
        restart_policy:
          condition: on-failure
        resources:
          limits:
            memory: 500MB
            cpus: "0.5"
        placement:
          constraints:
            - node.role==manager
      networks:
        - shield

volumes:
  elastic:
  portainer:
  admin:

networks:
  shield:
    driver: overlay
    ipam:
      driver: default
      config:
        - subnet: 192.168.0.0/24
secrets:
   shield-system-id:
       external: true
